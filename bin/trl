#!/usr/bin/env python3.7
"""Wrapper around trello-cli.
Invoke via `trl`. All commands and options are forwarded.

Setup trello-cli
- run: yarn global add trello-cli
- run: trello  # creates config file and instructs where to get app key from
- insert app key in config file
- run: trello  # instructs where to get credentials from
- run: trello set-auth <credentials>
"""
import subprocess
import sys
import pathlib

# Enable loading trl_config module from same directory
# Module content:
# - LISTS: list of list names
# - LABELS: dict of label IDs and names
# - DEFAULT_BOARD: str with default board name
# - MOVE_LISTS: dict of list aliases and list IDs
SCRIPT_DIR = pathlib.Path(__file__).absolute().parent
sys.path.insert(0, SCRIPT_DIR)

try:
    from trl_config import LISTS, LABELS, DEFAULT_BOARD, MOVE_LISTS
except ImportError:
    raise SystemExit("trl_config.py not found or incomplete.")


WORKSPACE_COMMANDS = [
    "add-board",
    "show-boards",
    "card-assign",  # card ID/name/URL
    "card-details",  # card ID/name/URL
    "move-card",  # card list
]
BOARD_COMMANDS = [
    "add-list",
    "show-labels",
    "show-lists",
]
LIST_COMMANDS = [
    "add-card",  # -l LIST(name) -g LABELS
    "show-cards",  # -l LIST(name)
    "delete-card",  # -l LIST(name)
]


def parse_cli():
    # First arg is command, followed by arbitrary options
    if len(sys.argv) > 1:
        return sys.argv[1], sys.argv[2:]
    # Fallback to help if no command specified
    return "--help", []


def main():
    command, options = parse_cli()
    trello_cmd = construct_trello_command(command, options)
    print(" ".join(trello_cmd))
    print()
    subprocess.run(trello_cmd)


def construct_trello_command(command, options):
    trello_cmd = ["trello", command]

    if "-h" in options or "--help" in options:
        pass

    elif command == "move-card":
        for flag, list_id in MOVE_LISTS.items():
            try:
                options.remove(flag)
                options.append(list_id)
                break
            except ValueError:
                pass

    elif command in BOARD_COMMANDS:
        trello_cmd.extend(["-b", DEFAULT_BOARD])

    elif command in LIST_COMMANDS:
        # Select list and add default board
        list_name = select_list()
        label_options = select_labels() if command == "add-card" else []
        trello_cmd.extend(["-b", DEFAULT_BOARD, "-l", list_name] + label_options)

    trello_cmd.extend(options)
    return trello_cmd


def select_list():
    try:
        proc = subprocess.run(["fzf"], input=bytes("\n".join(LISTS), encoding="utf-8"),
                              stdout=subprocess.PIPE)
        return proc.stdout.decode().strip()
    except Exception as e:
        print(e)
        list_names = "\n".join([f"{i:2d}: {name}" for i, name in enumerate(LISTS)])
        list_rank = input(f"{list_names}\nPlease select a list: ")
        return LISTS[int(list_rank)]


def select_labels():
    label_ids = sorted(LABELS.keys())
    label_names = "\n".join([f"{i:2d}: {LABELS[id]}" for i, id in enumerate(label_ids)])
    raw_label_ranks = input(f"{label_names}\nPlease select labels, comma-separated: ")
    try:
        label_ranks = [int(r) for r in raw_label_ranks.split(",")]
        return ["-g", ",".join([label_ids[r] for r in label_ranks])]
    except ValueError:
        # Fallback if no or invalid selection made
        return []


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        raise SystemExit("\nAborted by user.")
